<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8"></meta>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>SoulAccess Hub</title>
<style>
* {
  font-family: Arial, Helvetica, sans-serif;
}
</style>
<script>
const MAX_SEG_LEN = 8 * 1024 * 1024;

var FILESEL = null, UPLOAD = null, FILE_IDX = null, LOG = null;
function log(x) {
  if (LOG) {
    LOG.innerHTML += `<p>${x}</p>`;
  }
}

class Submission {
  constructor(file) {
    let reader = new FileReader();
    this.offset = 0;
    this.fileName = file.name;
    log("scheduled " + this.fileName + " for upload");
    reader.onloadend = () => {
      if (reader.error) {
        log(`failed to read from ${this.fileName} :` + reader.error);
        return;
      }
      this.buf = reader.result;
      this.update();
    };
    reader.readAsArrayBuffer(file);
  }
  update() {
    let len = Math.min(this.buf.byteLength, MAX_SEG_LEN);
    let xhr = new XMLHttpRequest();
    xhr.open('POST', `/api/v1/object/${this.fileName}?from=${this.offset}`);
    xhr.onreadystatechange = () => {
      if (xhr.readyState != xhr.DONE) { return; }
      if (xhr.status != 200) {
        log(`failed to upload ${this.fileName}`);
        return;
      }
      this.offset += len;
      if (this.offset < this.buf.byteLength) {
        let percentage = Math.round(this.offset * 100 / this.buf.byteLength) / 100;
        log(`upload progress ${this.fileName}: ${percentage}`);
        this.update();
      } else {
        log(`uploaded ${this.fileName}`);
      }
    };
    xhr.send(this.buf.slice(this.offset, this.offset + len));
  }
}
function submit() {
  let files = FILESEL.files;
  for (let i = 0; i < files.length; ++i) {
    new Submission(files[i]);
  }
}

function prettyFileSize(size) {
  if (size > 1073741824) {
    return Math.round(size * 100 / 1073741824) / 100 + "KB";
  } else if (size > 1048576) {
    return Math.round(size * 100 / 1048576) / 100 + "KB";
  } else if (size > 1024) {
    return Math.round(size * 100 / 1024) / 100 + "KB";
  } else {
    return size + "Byte";
  }
}
function refresh(page) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', "/api/v1/object/");
  xhr.onreadystatechange = () => {
    if (xhr.readyState == xhr.DONE && xhr.status == 200) {
      log("refreshed");
      let records = JSON.parse(xhr.responseText);
      let innerHTML = "";
      for (let i in records) {
        let record = records[i];
        let date = record.lastModifiedUtc.substr(0, 10);
        let time = record.lastModifiedUtc.substr(11, 8);
        innerHTML += `<tr><td><a href="./${record}">${record.name}</a></td>` +
        `<td>${prettyFileSize(record.fileSize)}</td>` +
        `<td>${date} ${time}</td></tr>`;
      }
      FILE_IDX.innerHTML = innerHTML;
    }
  };
  xhr.send();
}
</script>
</head>
<body>
<div id="content">
  <div id="upload-ui">
    <input type="file" id="filesel">
    <input type="button" id="upload" value="Upload" onclick="submit()">
  </div>
  <div id="download-ui">
    <input type="button" value="Refresh" onclick="refresh()">
    <table id="file-idx">
    </table>
  </div>
  <div id="log">
  </div>
</div>

<script>
FILESEL = document.getElementById("filesel");
UPLOAD = document.getElementById("uplaod");
FILE_IDX = document.getElementById("file-idx");
LOG = document.getElementById("log");
</script>

</body>
</html>
